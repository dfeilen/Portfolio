<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Devin Feilen</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --bg: #f5f5f3;
      --text: #111;
      --text-muted: #888;
      --border: #ddd;
    }

    html, body {
      height: 100%;
      overflow: hidden;
    }

    body {
      font-family: 'Space Mono', monospace;
      background: var(--bg);
      color: var(--text);
    }

    /* Navigation */
    .nav {
      position: fixed;
      bottom: 24px;
      right: 32px;
      z-index: 100;
      display: flex;
      gap: 16px;
      font-size: 12px;
      letter-spacing: 0.05em;
    }

    .category-btn {
      background: none;
      border: none;
      font-family: inherit;
      font-size: inherit;
      letter-spacing: inherit;
      color: var(--text);
      cursor: pointer;
      text-transform: uppercase;
      padding: 0;
      text-decoration: none;
    }

    .category-btn:hover {
      text-decoration: underline;
    }

    .category-btn.active {
      text-decoration: underline;
    }

    /* Refresh Button */
    .refresh-btn {
      position: fixed;
      bottom: 24px;
      left: 32px;
      z-index: 100;
      background: none;
      border: none;
      font-family: inherit;
      font-size: 12px;
      letter-spacing: 0.05em;
      color: var(--text);
      cursor: pointer;
      text-transform: uppercase;
      padding: 0;
    }

    .refresh-btn:hover {
      text-decoration: underline;
    }

    /* Popup Notice */
    .popup-notice {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 11px;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      color: var(--text-muted);
      z-index: 100;
      opacity: 0;
      transition: opacity 0.5s ease;
      pointer-events: none;
    }

    .popup-notice.visible {
      opacity: 1;
    }

    /* A&B Link */
    .ab-link {
      position: fixed;
      top: 24px;
      left: 32px;
      font-size: 11px;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      color: var(--text);
      text-decoration: none;
      z-index: 100;
      opacity: 0;
      transition: opacity 0.5s ease;
      pointer-events: none;
    }

    .ab-link.visible {
      opacity: 1;
      pointer-events: auto;
    }

    .ab-link:hover {
      text-decoration: underline;
    }

    /* About Box */
    .about-box {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 90%;
      max-width: 500px;
      background: var(--bg);
      padding: 40px;
      z-index: 60;
      opacity: 0;
      transition: opacity 0.5s ease;
      pointer-events: none;
    }

    .about-box.visible {
      opacity: 1;
      pointer-events: auto;
    }

    .about-box h2 {
      font-size: 14px;
      font-weight: 700;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      margin-bottom: 24px;
    }

    .about-box p {
      font-size: 13px;
      line-height: 1.8;
      margin-bottom: 16px;
      color: var(--text);
    }

    .about-box a {
      color: var(--text);
      text-decoration: underline;
    }

    .about-box a:hover {
      color: var(--text-muted);
    }

    /* Canvas Area */
    .canvas {
      position: fixed;
      inset: 0;
      overflow: hidden;
    }

    /* Floating Images */
    .float-img {
      position: absolute;
      opacity: 0;
      transform: scale(0.9);
      transition: opacity 0.5s ease, transform 0.5s ease;
      pointer-events: auto;
      cursor: grab;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }

    .float-img.visible {
      opacity: 1;
      transform: scale(1);
    }

    .float-img.dragging {
      cursor: grabbing;
      transition: none;
    }

    .float-img img {
      display: block;
      height: auto;
      max-width: 100%;
      pointer-events: none;
      user-select: none;
      -webkit-user-drag: none;
    }

    .float-img:hover {
      z-index: 50 !important;
    }

    /* Resize Handle */
    .resize-handle {
      position: absolute;
      bottom: -6px;
      right: -6px;
      width: 12px;
      height: 12px;
      background: var(--text);
      border: 2px solid var(--bg);
      border-radius: 50%;
      cursor: nwse-resize;
      opacity: 0;
      transition: opacity 0.2s ease;
      z-index: 10;
    }

    .float-img:hover .resize-handle {
      opacity: 1;
    }

    .resize-handle:hover {
      transform: scale(1.2);
    }

    /* Loading */
    .loading {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      z-index: 50;
      opacity: 1;
      transition: opacity 0.4s ease;
    }

    .loading.hidden {
      opacity: 0;
      pointer-events: none;
    }

    .loading-text {
      font-size: 11px;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      color: var(--text-muted);
    }

    /* Lightbox */
    .lightbox {
      position: fixed;
      inset: 0;
      background: var(--bg);
      z-index: 1000;
      display: none;
      flex-direction: column;
      opacity: 0;
      transition: opacity 0.4s ease;
    }

    .lightbox.active {
      display: flex;
    }

    .lightbox.visible {
      opacity: 1;
    }

    .lightbox-header {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      padding: 24px 32px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 10;
    }

    .lightbox-counter {
      font-size: 11px;
      letter-spacing: 0.05em;
      color: var(--text-muted);
      text-transform: uppercase;
    }

    .lightbox-close {
      font-size: 11px;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      background: none;
      border: 1px solid var(--border);
      padding: 10px 20px;
      cursor: pointer;
      font-family: inherit;
      color: var(--text);
      transition: all 0.2s ease;
    }

    .lightbox-close:hover {
      border-color: var(--text);
      background: var(--text);
      color: var(--bg);
    }

    .lightbox-content {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 80px 100px;
    }

    .lightbox-content img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      opacity: 0;
      transform: translateY(10px);
      transition: all 0.4s ease;
    }

    .lightbox.visible .lightbox-content img {
      opacity: 1;
      transform: translateY(0);
    }

    .lightbox-nav {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: 1px solid var(--border);
      width: 48px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .lightbox-nav:hover {
      border-color: var(--text);
      background: var(--text);
    }

    .lightbox-nav:hover svg {
      stroke: var(--bg);
    }

    .lightbox-nav svg {
      width: 20px;
      height: 20px;
      stroke: var(--text);
      stroke-width: 1.5;
      fill: none;
    }

    .lightbox-prev {
      left: 32px;
    }

    .lightbox-next {
      right: 32px;
    }

    /* Hide scroll hint on desktop */
    .scroll-hint {
      display: none;
    }

    /* Mobile Styles */
    @media (max-width: 768px) {
      html, body {
        height: 100%;
        overflow: hidden;
        touch-action: pan-y;
      }

      .nav {
        top: 20px;
        right: 20px;
        bottom: auto;
        flex-direction: column;
        align-items: flex-end;
        gap: 12px;
        font-size: 11px;
      }

      .refresh-btn {
        display: none;
      }

      .popup-notice {
        display: none;
      }

      .ab-link {
        top: 20px;
        left: 20px;
        font-size: 10px;
      }

      .canvas {
        position: fixed;
        inset: 0;
        overflow: hidden;
      }

      .float-img {
        position: absolute !important;
        opacity: 0;
        transform: scale(0.98);
        transition: opacity 0.4s ease, transform 0.4s ease;
        cursor: pointer;
        box-shadow: 0 4px 24px rgba(0,0,0,0.15);
      }

      .float-img.visible {
        opacity: 1;
        transform: scale(1);
      }

      .float-img img {
        width: 100%;
        height: auto;
        display: block;
        pointer-events: none;
      }

      .resize-handle {
        display: none;
      }

      .about-box {
        width: 85%;
        padding: 30px;
        max-height: 80vh;
        overflow-y: auto;
      }

      .about-box h2 {
        font-size: 13px;
        margin-bottom: 20px;
      }

      .about-box p {
        font-size: 12px;
        line-height: 1.7;
        margin-bottom: 14px;
      }

      .lightbox-content {
        padding: 80px 20px;
      }

      .lightbox-nav {
        width: 40px;
        height: 40px;
      }

      .lightbox-prev {
        left: 12px;
      }

      .lightbox-next {
        right: 12px;
      }

      /* Scroll hint */
      .scroll-hint {
        position: fixed;
        bottom: 30px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        z-index: 50;
        opacity: 1;
        transition: opacity 0.5s ease;
        pointer-events: none;
      }

      .scroll-hint.hidden {
        opacity: 0;
      }

      .scroll-hint-text {
        font-size: 10px;
        letter-spacing: 0.15em;
        text-transform: uppercase;
        color: var(--text-muted);
      }

      .scroll-hint-arrow {
        width: 20px;
        height: 20px;
        border-left: 1.5px solid var(--text-muted);
        border-bottom: 1.5px solid var(--text-muted);
        transform: rotate(-45deg);
        animation: scrollBounce 1.5s ease-in-out infinite;
      }

      @keyframes scrollBounce {
        0%, 100% { transform: rotate(-45deg) translateY(0); }
        50% { transform: rotate(-45deg) translateY(5px); }
      }
    }
  </style>
</head>
<body>
  <!-- Navigation -->
  <nav class="nav">
    <button class="category-btn active" data-category="cycling">Cycling</button>
    <button class="category-btn" data-category="life">Life</button>
    <button class="category-btn" data-category="ab">A&B</button>
    <button class="category-btn" data-category="people">People</button>
    <button class="category-btn" data-category="walls">Walls</button>
    <button class="category-btn" data-category="devin">Devin</button>
  </nav>

  <!-- Refresh Button (desktop only) -->
  <button class="refresh-btn" id="refresh-btn">Refresh</button>

  <!-- Popup Notice (desktop only) -->
  <div class="popup-notice" id="popup-notice">click drag & resize photos</div>

  <!-- A&B Link -->
  <a href="https://a-and-b.bike/" target="_blank" class="ab-link" id="ab-link">a-and-b.bike â†’</a>

  <!-- Loading -->
  <div class="loading" id="loading">
    <p class="loading-text">Loading</p>
  </div>

  <!-- Canvas -->
  <div class="canvas" id="canvas"></div>

  <!-- About Box -->
  <div class="about-box" id="about-box">
    <h2>About</h2>
    <p>Devin Feilen is a photographer based in Portland, Oregon. He can typically be found at cyclocross races around the PNW or wandering around with a Ricoh GR.</p>
    <p>Site design by yours truly and never squarespace.</p>
    <p>You can support me at <a href="https://buymeacoffee.com/devinfeilen" target="_blank">buymeacoffee.com/devinfeilen</a></p>
    <p>For usage/licensing or any questions, please contact me via Instagram <a href="https://instagram.com/devinfeilen" target="_blank">@devinfeilen</a> or via email at <a href="mailto:dfeeilen@gmail.com">dfeeilen@gmail.com</a></p>
    <p>Thank you for visiting :)</p>
  </div>

  <!-- Scroll Hint (mobile only) -->
  <div class="scroll-hint" id="scroll-hint">
    <span class="scroll-hint-text">Swipe up</span>
    <div class="scroll-hint-arrow"></div>
  </div>

  <!-- Lightbox -->
  <div class="lightbox" id="lightbox">
    <div class="lightbox-header">
      <span class="lightbox-counter">
        <span id="lightbox-current">01</span> / <span id="lightbox-total">00</span>
      </span>
      <button class="lightbox-close" id="lightbox-close">Close</button>
    </div>
    <button class="lightbox-nav lightbox-prev" id="lightbox-prev">
      <svg viewBox="0 0 24 24"><path d="M15 18l-6-6 6-6"/></svg>
    </button>
    <div class="lightbox-content">
      <img id="lightbox-img" alt="Photography by Devin Feilen">
    </div>
    <button class="lightbox-nav lightbox-next" id="lightbox-next">
      <svg viewBox="0 0 24 24"><path d="M9 18l6-6-6-6"/></svg>
    </button>
  </div>

  <script>
    // State
    let allPhotos = [];
    let displayedPhotos = [];
    let currentCategory = 'cycling';
    let lightboxIndex = 0;
    let isMobile = window.innerWidth <= 768;
    const imageCount = 15;

    // Mobile pile-up state
    let mobileImages = [];
    let photoQueue = [];
    let mobileZIndex = 1;
    let totalScrolled = 0;
    let lastTouchY = 0;
    let maxPileSize = 15; // Max images to keep in memory
    
    // Mobile scroll smoothing
    let velocity = 0;
    let lastScrollTime = 0;
    let isScrolling = false;
    let scrollTimeout = null;
    let horizontalBuffer = 30; // Buffer from screen edges

    // Elements
    const canvas = document.getElementById('canvas');
    const loading = document.getElementById('loading');
    const lightbox = document.getElementById('lightbox');
    const lightboxImg = document.getElementById('lightbox-img');
    const lightboxCurrent = document.getElementById('lightbox-current');
    const lightboxTotal = document.getElementById('lightbox-total');
    const scrollHint = document.getElementById('scroll-hint');
    const aboutBox = document.getElementById('about-box');
    const popupNotice = document.getElementById('popup-notice');
    const abLink = document.getElementById('ab-link');

    // Initialize
    loadCategory(currentCategory);

    // Category buttons
    document.querySelectorAll('.category-btn[data-category]').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        loadCategory(btn.dataset.category);
      });
    });

    // Refresh button (desktop only)
    document.getElementById('refresh-btn').addEventListener('click', () => {
      if (!isMobile) {
        displayImages();
      }
    });

    // Lightbox controls
    document.getElementById('lightbox-close').addEventListener('click', closeLightbox);
    document.getElementById('lightbox-prev').addEventListener('click', () => navigateLightbox(-1));
    document.getElementById('lightbox-next').addEventListener('click', () => navigateLightbox(1));
    lightbox.addEventListener('click', (e) => {
      if (e.target === lightbox || e.target.closest('.lightbox-content')) {
        closeLightbox();
      }
    });

    // Keyboard navigation
    document.addEventListener('keydown', (e) => {
      if (lightbox.classList.contains('active')) {
        if (e.key === 'Escape') closeLightbox();
        if (e.key === 'ArrowLeft') navigateLightbox(-1);
        if (e.key === 'ArrowRight') navigateLightbox(1);
      }
    });

    function loadCategory(category) {
      currentCategory = category;
      canvas.innerHTML = '';
      displayedPhotos = [];
      mobileImages = [];
      totalScrolled = 0;
      
      // Hide about box for non-devin categories
      if (category !== 'devin') {
        aboutBox.classList.remove('visible');
        loading.classList.remove('hidden');
      } else {
        // Show about box immediately for devin category
        aboutBox.classList.add('visible');
        if (isMobile && scrollHint) {
          scrollHint.classList.add('hidden');
        }
      }
      
      // Show/hide A&B link
      if (category === 'ab') {
        abLink.classList.add('visible');
      } else {
        abLink.classList.remove('visible');
      }
      
      const jsonFile = category + '.json';
      
      fetch(jsonFile)
        .then(res => {
          if (!res.ok) throw new Error('Not found');
          return res.json();
        })
        .then(data => {
          allPhotos = data;
          photoQueue = shuffleArray([...allPhotos]);
          loading.classList.add('hidden');
          
          if (category === 'devin') {
            // Only spawn background photos on desktop
            if (!isMobile) {
              spawnAboutPhotos();
            }
          } else if (isMobile) {
            initMobileExperience();
          } else {
            displayImages();
          }
        })
        .catch(err => {
          console.error('Error loading photos:', err);
          loading.classList.add('hidden');
          // About box is already visible, so text will show even without photos
        });
    }

    // ===== ABOUT SECTION =====
    
    function spawnAboutPhotos() {
      // Show popup notice
      showPopupNotice();
      
      // Get about box dimensions for collision avoidance
      const boxRect = aboutBox.getBoundingClientRect();
      const boxPadding = 40; // Extra padding around the box
      const excludeZone = {
        left: boxRect.left - boxPadding,
        right: boxRect.right + boxPadding,
        top: boxRect.top - boxPadding,
        bottom: boxRect.bottom + boxPadding
      };
      
      // Shuffle and pick 5 images
      const shuffled = shuffleArray([...allPhotos]);
      const selected = shuffled.slice(0, 5);
      
      // Spawn images avoiding the center
      selected.forEach((src, i) => {
        setTimeout(() => {
          spawnAboutImage(src, i, excludeZone);
        }, i * 150);
      });
    }

    function spawnAboutImage(src, index, excludeZone) {
      const wrapper = document.createElement('div');
      wrapper.className = 'float-img';
      
      const img = document.createElement('img');
      img.src = src;
      img.alt = 'Photography by Devin Feilen';
      img.loading = 'eager';
      
      // Smaller size for about page: 180-280px
      const targetWidth = 180 + Math.random() * 100;
      wrapper.style.width = targetWidth + 'px';
      
      // Add resize handle
      const resizeHandle = document.createElement('div');
      resizeHandle.className = 'resize-handle';
      wrapper.appendChild(resizeHandle);
      
      wrapper.appendChild(img);
      canvas.appendChild(wrapper);
      
      // Wait for image to load to get actual dimensions
      img.onload = () => {
        const aspectRatio = img.naturalWidth / img.naturalHeight;
        const actualHeight = targetWidth / aspectRatio;
        
        // Find position that doesn't overlap with center box
        let x, y;
        let attempts = 0;
        const padding = 60;
        
        do {
          x = padding + Math.random() * (window.innerWidth - targetWidth - padding * 2);
          y = padding + Math.random() * (window.innerHeight - actualHeight - padding * 2);
          attempts++;
        } while (
          attempts < 50 &&
          x < excludeZone.right &&
          x + targetWidth > excludeZone.left &&
          y < excludeZone.bottom &&
          y + actualHeight > excludeZone.top
        );
        
        wrapper.style.left = x + 'px';
        wrapper.style.top = y + 'px';
        wrapper.style.zIndex = index + 1;
        
        // Make draggable
        makeDraggable(wrapper);
        
        // Make resizable
        makeResizable(wrapper, img, resizeHandle);
        
        // Fade in after positioning
        requestAnimationFrame(() => {
          requestAnimationFrame(() => {
            wrapper.classList.add('visible');
          });
        });
      };
      
      // Double-click to open lightbox
      wrapper.addEventListener('dblclick', () => {
        openLightbox(src);
      });
      
      displayedPhotos.push(src);
    }

    // ===== MOBILE PILE-UP EXPERIENCE =====
    
    function initMobileExperience() {
      canvas.innerHTML = '';
      mobileImages = [];
      mobileZIndex = 1;
      totalScrolled = 0;
      velocity = 0;
      
      // Show scroll hint
      if (scrollHint) {
        scrollHint.classList.remove('hidden');
      }
      
      // Spawn initial images in a queue below the screen
      for (let i = 0; i < 5; i++) {
        spawnMobileImage(i);
      }
      
      // Touch handlers
      canvas.addEventListener('touchstart', handleTouchStart, { passive: true });
      canvas.addEventListener('touchmove', handleTouchMove, { passive: false });
      canvas.addEventListener('touchend', handleTouchEnd, { passive: true });
    }

    function handleTouchStart(e) {
      lastTouchY = e.touches[0].clientY;
      lastScrollTime = Date.now();
      velocity = 0;
      isScrolling = true;
      
      // Disable pointer events on all images while scrolling
      mobileImages.forEach(imgData => {
        imgData.wrapper.style.pointerEvents = 'none';
      });
      
      // Clear any existing scroll timeout
      if (scrollTimeout) {
        clearTimeout(scrollTimeout);
      }
    }

    function handleTouchMove(e) {
      const currentY = e.touches[0].clientY;
      const currentTime = Date.now();
      const deltaY = lastTouchY - currentY; // Positive = scrolling up, Negative = scrolling down
      const deltaTime = currentTime - lastScrollTime;
      
      // Calculate velocity for momentum
      if (deltaTime > 0) {
        velocity = deltaY / deltaTime * 16; // Normalize to ~60fps
      }
      
      lastTouchY = currentY;
      lastScrollTime = currentTime;
      
      applyScroll(deltaY);
      
      e.preventDefault();
    }

    function handleTouchEnd(e) {
      // Apply momentum scrolling
      if (Math.abs(velocity) > 0.5) {
        requestAnimationFrame(applyMomentum);
      } else {
        endScrolling();
      }
    }
    
    function applyMomentum() {
      if (Math.abs(velocity) < 0.3) {
        endScrolling();
        return;
      }
      
      // Apply friction
      velocity *= 0.92;
      
      applyScroll(velocity);
      
      requestAnimationFrame(applyMomentum);
    }
    
    function endScrolling() {
      // Delay before allowing taps
      scrollTimeout = setTimeout(() => {
        isScrolling = false;
        // Enable pointer events on all images
        mobileImages.forEach(imgData => {
          imgData.wrapper.style.pointerEvents = 'auto';
        });
      }, 300);
    }
    
    function handleMobileTap(src) {
      if (!isScrolling) {
        openLightbox(src);
      }
    }
    
    function applyScroll(deltaY) {
      // Calculate new scroll position
      const newScrolled = totalScrolled + deltaY;
      
      // Clamp to prevent scrolling too far back
      if (newScrolled < 0) {
        // Only move by the amount that gets us to 0
        deltaY = -totalScrolled;
        totalScrolled = 0;
        if (deltaY === 0) return;
      } else {
        totalScrolled = newScrolled;
      }
      
      // Hide scroll hint after first scroll
      if (scrollHint && totalScrolled > 50) {
        scrollHint.classList.add('hidden');
      }
      
      // Move all images based on scroll
      mobileImages.forEach(imgData => {
        imgData.y -= deltaY;
        imgData.wrapper.style.top = imgData.y + 'px';
      });
      
      // Only spawn new images when scrolling up (deltaY > 0)
      if (deltaY > 0) {
        const lowestImage = mobileImages.reduce((lowest, img) => {
          return img.y > lowest.y ? img : lowest;
        }, { y: -Infinity });
        
        if (lowestImage.y < window.innerHeight + 200) {
          spawnMobileImage(mobileImages.length);
        }
      }
      
      // Cleanup images that are too far off screen (above)
      cleanupMobileImages();
    }

    function spawnMobileImage(index) {
      if (photoQueue.length === 0) {
        photoQueue = shuffleArray([...allPhotos]);
      }
      
      const src = photoQueue.pop();
      const wrapper = document.createElement('div');
      wrapper.className = 'float-img';
      
      const img = document.createElement('img');
      img.src = src;
      img.alt = 'Photography by Devin Feilen';
      img.loading = 'eager';
      
      // Random size between 50-75% of screen width
      const widthPercent = 0.50 + Math.random() * 0.25;
      const size = window.innerWidth * widthPercent;
      wrapper.style.width = size + 'px';
      
      // Random horizontal position with buffer from edges
      const maxX = window.innerWidth - size - horizontalBuffer;
      const x = horizontalBuffer + Math.random() * (maxX - horizontalBuffer);
      
      // Position below the lowest existing image, or at base position if first
      const spacing = window.innerHeight * 0.7; // 70% of screen height between images
      let y;
      
      if (mobileImages.length === 0) {
        y = window.innerHeight + 100 + (index * spacing);
      } else {
        const lowestImage = mobileImages.reduce((lowest, img) => {
          return img.y > lowest.y ? img : lowest;
        }, { y: window.innerHeight });
        y = lowestImage.y + spacing;
      }
      
      wrapper.style.left = x + 'px';
      wrapper.style.top = y + 'px';
      wrapper.style.zIndex = mobileZIndex++;
      
      // Disable pointer events initially
      wrapper.style.pointerEvents = 'none';
      
      wrapper.appendChild(img);
      canvas.appendChild(wrapper);
      
      // Fade in
      requestAnimationFrame(() => {
        requestAnimationFrame(() => {
          wrapper.classList.add('visible');
        });
      });
      
      // Tap to open lightbox (only works when not scrolling)
      wrapper.addEventListener('click', () => {
        handleMobileTap(src);
      });
      
      const imgData = {
        wrapper,
        src,
        x,
        y,
        zIndex: mobileZIndex
      };
      
      mobileImages.push(imgData);
      displayedPhotos.push(src);
    }

    function cleanupMobileImages() {
      // Remove images that have scrolled too far above the screen
      const toRemove = mobileImages.filter(img => img.y < -500);
      
      toRemove.forEach(imgData => {
        imgData.wrapper.style.opacity = '0';
        
        setTimeout(() => {
          if (imgData.wrapper.parentNode) {
            imgData.wrapper.remove();
          }
        }, 300);
        
        // Remove from arrays
        const idx = mobileImages.indexOf(imgData);
        if (idx > -1) mobileImages.splice(idx, 1);
        
        const srcIdx = displayedPhotos.indexOf(imgData.src);
        if (srcIdx > -1) displayedPhotos.splice(srcIdx, 1);
      });
    }

    // ===== DESKTOP EXPERIENCE =====

    function displayImages() {
      // Clear existing
      canvas.innerHTML = '';
      displayedPhotos = [];
      
      // Show popup notice
      showPopupNotice();
      
      // Shuffle and pick images
      const shuffled = shuffleArray([...allPhotos]);
      const selected = shuffled.slice(0, imageCount);
      
      // Staggered reveal
      selected.forEach((src, i) => {
        setTimeout(() => {
          spawnImage(src, i);
        }, i * 120);
      });
    }
    
    function showPopupNotice() {
      if (!isMobile && popupNotice) {
        popupNotice.classList.add('visible');
        setTimeout(() => {
          popupNotice.classList.remove('visible');
        }, 5000);
      }
    }

    function spawnImage(src, index) {
      const wrapper = document.createElement('div');
      wrapper.className = 'float-img';
      
      const img = document.createElement('img');
      img.src = src;
      img.alt = 'Photography by Devin Feilen';
      img.loading = 'eager';
      
      // Random width between 250-400px
      const targetWidth = 250 + Math.random() * 150;
      wrapper.style.width = targetWidth + 'px';
      
      // Add resize handle
      const resizeHandle = document.createElement('div');
      resizeHandle.className = 'resize-handle';
      wrapper.appendChild(resizeHandle);
      
      wrapper.appendChild(img);
      canvas.appendChild(wrapper);
      
      // Wait for image to load to get actual dimensions
      img.onload = () => {
        const aspectRatio = img.naturalWidth / img.naturalHeight;
        const actualHeight = targetWidth / aspectRatio;
        
        // Random position with padding from edges, accounting for actual height
        const padding = 60;
        const maxX = Math.max(padding, window.innerWidth - targetWidth - padding);
        const maxY = Math.max(padding, window.innerHeight - actualHeight - padding);
        const x = padding + Math.random() * (maxX - padding);
        const y = padding + Math.random() * (maxY - padding);
        
        wrapper.style.left = x + 'px';
        wrapper.style.top = y + 'px';
        wrapper.style.zIndex = index + 1;
        
        // Make draggable
        makeDraggable(wrapper);
        
        // Make resizable
        makeResizable(wrapper, img, resizeHandle);
        
        // Fade in after positioning
        requestAnimationFrame(() => {
          requestAnimationFrame(() => {
            wrapper.classList.add('visible');
          });
        });
      };
      
      // Double-click to open lightbox
      wrapper.addEventListener('dblclick', () => {
        openLightbox(src);
      });
      
      displayedPhotos.push(src);
    }

    function makeDraggable(wrapper) {
      let isDragging = false;
      let hasMoved = false;
      let startX, startY, initialLeft, initialTop;
      
      wrapper.addEventListener('mousedown', (e) => {
        // Ignore if clicking resize handle
        if (e.target.classList.contains('resize-handle')) return;
        
        isDragging = true;
        hasMoved = false;
        wrapper.classList.add('dragging');
        
        startX = e.clientX;
        startY = e.clientY;
        initialLeft = wrapper.offsetLeft;
        initialTop = wrapper.offsetTop;
        
        // Bring to front
        wrapper.style.zIndex = getMaxZIndex() + 1;
        
        e.preventDefault();
      });
      
      document.addEventListener('mousemove', (e) => {
        if (!isDragging) return;
        
        const deltaX = e.clientX - startX;
        const deltaY = e.clientY - startY;
        
        if (Math.abs(deltaX) > 3 || Math.abs(deltaY) > 3) {
          hasMoved = true;
        }
        
        wrapper.style.left = (initialLeft + deltaX) + 'px';
        wrapper.style.top = (initialTop + deltaY) + 'px';
      });
      
      document.addEventListener('mouseup', () => {
        if (isDragging) {
          isDragging = false;
          wrapper.classList.remove('dragging');
        }
      });
    }

    function makeResizable(wrapper, img, handle) {
      let isResizing = false;
      let startX, startY, startWidth, startHeight, aspectRatio;
      
      handle.addEventListener('mousedown', (e) => {
        isResizing = true;
        startX = e.clientX;
        startY = e.clientY;
        startWidth = wrapper.offsetWidth;
        startHeight = img.offsetHeight;
        aspectRatio = img.naturalWidth / img.naturalHeight;
        
        // Bring to front
        wrapper.style.zIndex = getMaxZIndex() + 1;
        
        e.preventDefault();
        e.stopPropagation();
      });
      
      document.addEventListener('mousemove', (e) => {
        if (!isResizing) return;
        
        const deltaX = e.clientX - startX;
        const deltaY = e.clientY - startY;
        const delta = Math.max(deltaX, deltaY);
        
        let newWidth = startWidth + delta;
        newWidth = Math.max(100, Math.min(newWidth, window.innerWidth * 0.8));
        
        wrapper.style.width = newWidth + 'px';
      });
      
      document.addEventListener('mouseup', () => {
        isResizing = false;
      });
    }

    function getMaxZIndex() {
      let max = 0;
      document.querySelectorAll('.float-img').forEach(el => {
        const z = parseInt(el.style.zIndex) || 0;
        if (z > max) max = z;
      });
      return max;
    }

    function openLightbox(src) {
      lightboxIndex = allPhotos.indexOf(src);
      if (lightboxIndex === -1) lightboxIndex = 0;
      
      lightboxImg.src = src;
      lightboxCurrent.textContent = String(lightboxIndex + 1).padStart(2, '0');
      lightboxTotal.textContent = String(allPhotos.length).padStart(2, '0');
      
      lightbox.classList.add('active');
      document.body.style.overflow = 'hidden';
      
      setTimeout(() => lightbox.classList.add('visible'), 10);
    }

    function closeLightbox() {
      lightbox.classList.remove('visible');
      setTimeout(() => {
        lightbox.classList.remove('active');
        document.body.style.overflow = '';
      }, 400);
    }

    function navigateLightbox(dir) {
      lightboxIndex = (lightboxIndex + dir + allPhotos.length) % allPhotos.length;
      
      lightboxImg.style.opacity = '0';
      lightboxImg.style.transform = 'translateY(10px)';
      
      setTimeout(() => {
        lightboxImg.src = allPhotos[lightboxIndex];
        lightboxCurrent.textContent = String(lightboxIndex + 1).padStart(2, '0');
        lightboxImg.style.opacity = '1';
        lightboxImg.style.transform = 'translateY(0)';
      }, 200);
    }

    function shuffleArray(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    // Handle resize
    window.addEventListener('resize', () => {
      const wasMobile = isMobile;
      isMobile = window.innerWidth <= 768;
      
      if (wasMobile !== isMobile) {
        loadCategory(currentCategory);
      }
    });
  </script>
</body>
</html>
